# Internationalization — Louhen Landing

Locked routing decisions follow [/CONTEXT/naming.md](naming.md) and the migration plan in [/CONTEXT/rename_map.md](rename_map.md).

## Supported Locales & Route Shape
- **Locales:** `en`, `de`, `fr`, `nl`, `it`, `en-de`, `de-de`, `fr-fr`, `nl-nl`, `it-it` (source of truth: `next-intl.locales.ts`).
- **Default locale:** `de-de` (locked). Fallback logic still consults `NEXT_PUBLIC_DEFAULT_LOCALE` but reverts to `de-de` if overrides are missing.
- **Route shape:** All marketing routes live under `app/(site)/[locale]/…` using lowercase BCP-47 segments. Routes without a prefix are still required to call `unstable_setRequestLocale(defaultLocale)` server-side so metadata, hreflang, and header copy stay aligned.
- **Canonical host:** always `https://www.louhen.app/{locale}/…` (see `/CONTEXT/seo.md` for launch/noindex rules).

## Namespaces & Fallbacks
- Source messages now live under `messages/<locale>/<namespace>.json`. Core namespaces:
  - `common` — header/footer/layout scaffolding, trustCopy, shared CTAs.
  - `home` — hero, trust, story, FAQ, voucher.
  - `waitlist` — waitlist flows, confirm, share, referral, pre-onboarding.
  - `method` — method page copy and JSON-LD inputs.
  - `legal`, `imprint`, `status`, `errors`, `sitemap` — specialised surfaces.
- The loader merges namespaces per request with a strict fallback chain:
  1. `messages/en/<namespace>.json` (canonical, complete).
  2. `messages/<language>/<namespace>.json` (language-wide deltas; omit keys identical to English).
  3. `messages/<language-region>/<namespace>.json` (market-specific adjustments only).
- In dev, `safeGetMessage` logs a one-time warning when a key falls back past the active locale. It now returns an empty string when a key is missing so SSR never 500s; CI guards prevent this from shipping.
- Never embed user-facing literals in pages or server routes; pull every string from the merged message bundle with `safeGetMessage` or `t()`.
- `messages/en/<namespace>.json` is the canonical and complete definition. Language (`messages/<language>/…`) and market deltas (`messages/<language-region>/…`) only override what differs from English.
- `npm run i18n:check` (automatically run during `prebuild`) validates the canonical English bundles against the required key manifest and blocks missing keys in CI. The command now prints a per-locale coverage snapshot for each namespace so translators can see where overrides are still missing.
- Run `npm run update:i18n-manifest` whenever you add or remove `safeGetMessage` usages. It refreshes `i18n-required/*.json`, which the validator reads to enforce canonical coverage.
- Husky runs `lint-staged` on each commit; when `messages/en/**/*.json` files are staged the validator is invoked in scoped mode so only the affected namespaces are checked. Commits with no canonical changes skip the validator entirely.
- For ad-hoc reports use `node scripts/check-i18n-placeholders.mjs --coverage-only` (or pass `--ns waitlist,home` to focus on specific namespaces).
- Legacy root monoliths (`messages/en.json`, `messages/de.json`, etc.) remain temporarily for reference but are ignored by the runtime loader. Delete them in the follow-up cleanup once CI is green.
- When adding a namespace, wire it into `lib/intl/loadMessages.ts` and keep the English bundle exhaustive before exporting placeholders for translators.

## Legal Namespaces
- New translation namespaces: `legal.terms.*` and `legal.privacy.*`.
- Use nested keys for sections (e.g., `legal.terms.title`, `legal.privacy.dataRights.heading`). Keep keys human-readable.
- Shared snippets (e.g., contact addresses, consent statements) live in `legal.common.*` to avoid duplication.
- Metadata builders rely on:
  - `method.seo.title` and `method.seo.description` for marketing routes.
  - `legal.terms.title`, `legal.terms.intro`, `legal.privacy.title`, and at least the first entry in `legal.privacy.purpose.items` to seed descriptions.

## Placeholder & Entity Handling
## Message Formatting Rules
- Use `t()` for plain messages with simple `{placeholder}` values and pass already formatted strings (no React nodes).
- Use ICU formats for dates/numbers (e.g., `{date, date, long}`) when passing Date/number objects.
- Use `t.rich()` only when translations contain inline tags; provide handlers for every tag (e.g., `strong`, `link`, `email`).
- Keep placeholders identical across locales and align with the arguments passed in code (no extra or missing keys).
- Avoid escaped double braces; prefer `<tag>{value}</tag>` for rich messages.

- Company name/address remain placeholders until GmbH registration. Represent them as `[[Company legal name pending GmbH registration]]` in source messages so translators keep them intact.
- Tag data-subject contact emails (`legal@louhen.eu`, `privacy@louhen.eu`) as non-translatable strings.
- When analytics consent tooling changes, update the shared copy once in `legal.common.analyticsConsent` and re-export catalogs.

## Workflow
- Source of truth is the English (`en`) catalog committed in `messages/`.
- For each new legal section:
  1. Add English copy to the relevant namespace.
  2. Export placeholder files for other locales via the existing `next-intl` scripts (see `package.json` `messages:*` commands).
  3. Mark untranslated strings with `[[TODO-translate]]` so Playwright regression tests flag missing copy.
  4. Review translations with legal counsel before publishing.

## Header Locale Handling
- Default-locale routes that render the header must call `unstable_setRequestLocale(defaultLocale)` on the server before streaming to ensure the client header hydrates with the same locale (prevents flashes when switching to `/` without a prefix).
- The header locale switcher (Slice 3) preserves the current pathname and query string via `lib/intl/localePath.ts`. When targeting the default locale, drop the prefix; otherwise prefix with the BCP-47 code. Use `router.replace` after hydration to avoid duplicate history entries and maintain scroll position.
- `/locale/switch` handles the no-JS fallback. It expects `POST` with `locale`, `path`, and `search`, sets the `NEXT_LOCALE` cookie (`SameSite=Lax`, 1-year max-age), and redirects to the computed locale-aware href.
- Persist locale choice via that cookie; never store locale inside consent cookies or analytics storage. Client switcher must only touch `NEXT_LOCALE`.
- Locale changes must not clear consent or waitlist cookies. Guard the header switch handler so it only updates locale context and leaves `ll_consent` untouched.
- Header CTA and ribbon copy live under `header.cta.*` and `header.ribbon.<id>.*`; add locale-specific variants whenever a new campaign launches. Use descriptive IDs (`spring24`, `beta-invite`) so analytics dashboards line up with translation keys.

## Date & Revision Formatting
- Display last-updated timestamps using locale-specific long-date formats (e.g., `January 5, 2026` for `en`, `5. Januar 2026` for `de`).
- Store the canonical ISO string (`YYYY-MM-DD`) alongside the localized output for audit trails; expose ISO strings in structured data only.
- Update the revision date simultaneously across Terms, Privacy, and sitemap metadata to keep change logs aligned.

## Testing Hooks
- Tests should assert that `<h1>` and metadata titles come from the `legal.*` namespaces, not hardcoded strings.
- Fallback locale must never leak; default locale pages should render without duplicated prefixes in canonical URLs.
- Every Playwright route test must exercise the default locale (`de-de`) and at least one non-default locale (rotate between `en-de`, `fr-fr`, `nl-nl`, `it-it`) to ensure translations, consent copy, and metadata stay in sync.
- Avoid asserting localized marketing copy with literal text—prefer roles, accessible names, or `data-testid="lh-…"` hooks. Reserve text assertions for fixed legal copy explicitly marked as non-translatable.
- Assert `<html lang>`, `hreflang`, and canonical URLs whenever metadata is under test. Locale switcher specs must confirm cookies persist and consent/waitlist state is unaffected by locale changes.
- Axe scans run per locale; treat locale-specific accessibility failures as blockers alongside functional ones.

- 2025-02-14 — Legal namespaces seeded (Pattern A: extended messages/en.json and messages/de.json).

- 2025-02-14 — BCP-47 overlays added (en-de/de-de) with fallback chains documented.

- 2025-10-09 — Supported locale list frozen (`en`, `de`, `en-de`, `de-de`, `de-at`); `unstable_setRequestLocale` mandated for default-locale routes. (Superseded by the 2025-10-10 default-locale switch; `de-at` stays parked until Austria launch.)
- **2025-10-10 — Default locale set to `de-de` (Owner: Localization & SEO).** Keep Germany-native copy as the primary experience; English (`en-de`) remains available as an alternate locale for audits and support.

## Locale-Scoped Routing Policy (2025-10-13)

**Principle**  
All user-facing pages in Louhen Landing and future web surfaces must reside inside the localized route segment:

```
app/(site)/[locale]/
```

This ensures full consistency across i18n, consent, analytics, SEO, and accessibility layers.

**Rules**
1. Every public page (marketing, legal, onboarding, waitlist, method, etc.) belongs to a locale segment, e.g. `/de-de/method`, `/fr-fr/waitlist`.
2. The root `/` and short aliases (`/de`, `/en`, etc.) exist solely as redirect entry points (handled by middleware or `next.config.ts`).
3. No non-localized page (e.g. `/waitlist`, `/method`) should render directly — such requests must either:
   - Redirect to their locale equivalent (during transition periods), or
   - Return `404` once migration to `[locale]` is complete.
4. Layouts, metadata, and message loading are resolved through the `[locale]/layout.tsx` hierarchy, which wraps all downstream pages in `NextIntlClientProvider`.
5. E2E tests, sitemaps, and internal navigation must always construct URLs using locale-prefixed helpers such as `localeUrl('/path', { locale })`.

**Benefits**
- Uniform i18n handling and translation coverage.
- Simplified SEO and hreflang consistency.
- Unified analytics context (locale awareness in all sessions).
- Scalable cross-market rollout (EU-first strategy alignment).

**Cross-References**
- `/CONTEXT/architecture.md#routing`
- `/CONTEXT/seo.md#hreflang-and-locale-paths`
- `tests/e2e/_utils/url.ts`

- 2025-10-17 — Namespace loader resolves `en → <language> → <language-region>` for every request. Legacy monoliths under `messages/*.json` are deprecated and scheduled for removal after CI greenlight.

## Local Loopback Policy
- Developer tooling and automated tests bind servers to `127.0.0.1` exclusively. Avoid `localhost` and IPv6 loopbacks in configs so Next.js rewrites and Playwright network rules stay aligned.
- `HOST=127.0.0.1` is exported anywhere we spawn the production build locally (`npm run start:e2e`, Playwright webServer, validation scripts).
